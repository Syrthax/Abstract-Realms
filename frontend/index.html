<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Abstract Realms â€“ Custom Merch</title>
  <link rel="stylesheet" href="styles.css" />
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet" />
</head>
<body>

<!-- â”€â”€ Navbar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<nav class="navbar">
  <div class="container">
    <span class="brand">Abstract Realms</span>
    <nav>
      <a href="index.html">Shop</a>
      <a href="cart.html" class="cart-link">
        Cart
        <span class="cart-badge" style="display:none">0</span>
      </a>
    </nav>
  </div>
</nav>

<!-- â”€â”€ Hero â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<section class="hero">
  <div class="container">
    <h1>Custom Merch, Made for You</h1>
    <p>Upload your design on mugs, keychains, magnets and badges. Personalised &amp; printed just the way you like it.</p>
    <a href="#products" class="btn btn-primary btn-lg">Browse Products</a>
  </div>
</section>

<!-- â”€â”€ Products â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<section class="section" id="products">
  <div class="container">
    <h2 style="margin-bottom:32px">Our Products</h2>
    <div id="products-grid" class="products-grid">
      <!-- skeleton -->
      <div class="card" style="height:340px">
        <div class="thumb"></div>
        <div class="card-body"><div class="spinner"></div></div>
      </div>
    </div>
  </div>
</section>

<!-- â”€â”€ Product modal â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<div id="product-modal" class="modal-backdrop">
  <div class="modal">
    <div class="modal-header">
      <h3 id="modal-title">Product</h3>
      <button class="modal-close" onclick="closeModal()">Ã—</button>
    </div>

    <div id="modal-body">
      <!-- variant selection -->
      <div id="variant-section" class="hidden">
        <div class="form-group">
          <label>Material</label>
          <div id="material-chips" class="variant-grid"></div>
        </div>
        <div class="form-group" id="shape-group">
          <label>Shape</label>
          <div id="shape-chips" class="variant-grid"></div>
        </div>
      </div>

      <!-- image upload -->
      <div class="form-group">
        <label>Custom Image (optional)</label>
        <div id="upload-zone" class="upload-zone">
          <div class="icon">ğŸ–¼ï¸</div>
          <p>Click or drag &amp; drop your image here</p>
          <p style="font-size:.8rem;margin-top:4px">PNG / JPG / WEBP â€” max 5 MB</p>
          <input type="file" id="image-input" accept="image/*" style="display:none" />
          <img id="upload-preview" class="upload-preview hidden" alt="preview" />
        </div>
      </div>

      <div class="form-group">
        <label>Quantity</label>
        <input type="number" id="modal-qty" value="1" min="1" max="20" style="width:100px" />
      </div>

      <div style="display:flex;align-items:center;justify-content:space-between;margin-top:16px">
        <div>
          <div class="text-muted" style="font-size:.85rem">Price</div>
          <div id="modal-price" style="font-size:1.5rem;font-weight:800;color:var(--accent-light)">â‚¹0</div>
        </div>
        <button class="btn btn-primary" onclick="addToCartFromModal()">Add to Cart</button>
      </div>
    </div>
  </div>
</div>

<div id="toast-container"></div>
<script src="script.js"></script>
<script>
let products = [];
let selectedProduct = null;
let uploadedImageUrl = null;
let selectedMaterial = null;
let selectedShape = null;

// â”€â”€ Fetch products â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadProducts() {
  try {
    products = await apiFetch("/api/products");
    renderProducts();
  } catch (e) {
    document.getElementById("products-grid").innerHTML =
      '<p class="text-muted">Failed to load products. Please try again.</p>';
  }
}

function renderProducts() {
  const grid = document.getElementById("products-grid");
  if (!products.length) {
    grid.innerHTML = '<div class="empty-state"><div class="icon">ğŸ›ï¸</div><p>No products yet.</p></div>';
    return;
  }
  grid.innerHTML = products.map((p) => `
    <div class="card product-card" onclick="openModal('${p.id}')">
      <div class="thumb" style="font-size:4rem;display:flex;align-items:center;justify-content:center">
        ${categoryEmoji(p.category)}
      </div>
      <div class="card-body">
        <span class="cat-badge">${p.category}</span>
        <h3>${p.name}</h3>
        <div class="price">From ${formatINR(p.base_price)}</div>
        <button class="btn btn-primary btn-sm w-full mt-4">Customise</button>
      </div>
    </div>
  `).join("");
}

// â”€â”€ Modal â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function openModal(productId) {
  selectedProduct = products.find((p) => p.id === productId);
  if (!selectedProduct) return;
  selectedMaterial = null;
  selectedShape = null;
  uploadedImageUrl = null;

  document.getElementById("modal-title").textContent = selectedProduct.name;
  document.getElementById("modal-qty").value = 1;
  document.getElementById("upload-preview").classList.add("hidden");

  // Variants
  const hasVariants = selectedProduct.variants && selectedProduct.variants.length > 0;
  const varSection = document.getElementById("variant-section");
  varSection.classList.toggle("hidden", !hasVariants);

  if (hasVariants) {
    const materials = [...new Set(selectedProduct.variants.filter(v => v.material).map(v => v.material))];
    const shapes    = [...new Set(selectedProduct.variants.filter(v => v.shape).map(v => v.shape))];

    const matDiv = document.getElementById("material-chips");
    const shapeDiv = document.getElementById("shape-chips");
    document.getElementById("shape-group").classList.toggle("hidden", shapes.length === 0);

    matDiv.innerHTML = materials.map(m => `
      <div class="variant-chip" data-material="${m}" onclick="selectMaterial('${m}')">${m}</div>
    `).join("");
    shapeDiv.innerHTML = shapes.map(s => `
      <div class="variant-chip" data-shape="${s}" onclick="selectShape('${s}')">${s.replace(/_/g," ")}</div>
    `).join("");
  }

  updateModalPrice();
  document.getElementById("product-modal").classList.add("open");
}

function closeModal() {
  document.getElementById("product-modal").classList.remove("open");
}

function selectMaterial(m) {
  selectedMaterial = m;
  document.querySelectorAll("#material-chips .variant-chip").forEach(c => {
    c.classList.toggle("selected", c.dataset.material === m);
  });
  updateModalPrice();
}

function selectShape(s) {
  selectedShape = s;
  document.querySelectorAll("#shape-chips .variant-chip").forEach(c => {
    c.classList.toggle("selected", c.dataset.shape === s);
  });
  updateModalPrice();
}

function getSelectedVariant() {
  if (!selectedProduct || !selectedProduct.variants?.length) return null;
  return selectedProduct.variants.find(v =>
    (v.material === selectedMaterial || !v.material) &&
    (v.shape === selectedShape || !v.shape)
  ) || null;
}

function updateModalPrice() {
  if (!selectedProduct) return;
  const variant = getSelectedVariant();
  const price = selectedProduct.base_price + (variant?.price_modifier ?? 0);
  document.getElementById("modal-price").textContent = formatINR(price);
}

// â”€â”€ Image upload â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
document.addEventListener("DOMContentLoaded", () => {
  const zone = document.getElementById("upload-zone");
  const input = document.getElementById("image-input");

  zone.addEventListener("click", () => input.click());
  zone.addEventListener("dragover", (e) => { e.preventDefault(); zone.classList.add("dragover"); });
  zone.addEventListener("dragleave", () => zone.classList.remove("dragover"));
  zone.addEventListener("drop", (e) => {
    e.preventDefault(); zone.classList.remove("dragover");
    if (e.dataTransfer.files[0]) handleImageFile(e.dataTransfer.files[0]);
  });
  input.addEventListener("change", () => { if (input.files[0]) handleImageFile(input.files[0]); });
});

async function handleImageFile(file) {
  if (file.size > 5 * 1024 * 1024) { toast("Image must be under 5 MB", "error"); return; }
  const preview = document.getElementById("upload-preview");
  preview.src = URL.createObjectURL(file);
  preview.classList.remove("hidden");

  try {
    showLoading();
    const fd = new FormData();
    fd.append("image", file);
    const res = await fetch(API_BASE + "/api/upload-image", { method: "POST", body: fd });
    const data = await res.json();
    if (!res.ok) throw new Error(data.error);
    uploadedImageUrl = data.url;
    toast("Image uploaded!", "success");
  } catch (e) {
    toast("Upload failed: " + e.message, "error");
    uploadedImageUrl = null;
  } finally {
    hideLoading();
  }
}

// â”€â”€ Add to cart â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function addToCartFromModal() {
  if (!selectedProduct) return;
  const variant = getSelectedVariant();
  const hasVariants = selectedProduct.variants?.length > 0;
  if (hasVariants && !variant) {
    toast("Please select a variant", "error"); return;
  }
  const qty = parseInt(document.getElementById("modal-qty").value) || 1;
  const price = selectedProduct.base_price + (variant?.price_modifier ?? 0);
  const variantLabel = variant
    ? [variant.material, variant.shape].filter(Boolean).map(s => s.replace(/_/g," ")).join(" Â· ")
    : "";

  Cart.add({
    product_id: selectedProduct.id,
    product_name: selectedProduct.name,
    category: selectedProduct.category,
    variant_id: variant?.id ?? null,
    variant_label: variantLabel,
    price,
    image_url: uploadedImageUrl,
  });

  // update qty directly
  const items = Cart.getAll();
  const idx = items.findIndex(i => i.product_id === selectedProduct.id && i.variant_id === (variant?.id ?? null));
  if (idx !== -1 && qty > 1) { Cart.updateQty(idx, qty); }

  toast(`${selectedProduct.name} added to cart!`, "success");
  closeModal();
}

loadProducts();
</script>
</body>
</html>
