<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Admin â€“ Abstract Realms</title>
  <link rel="stylesheet" href="styles.css" />
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet" />
</head>
<body>

<!-- â”€â”€ Login screen â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<div id="login-screen" style="min-height:100vh;display:flex;align-items:center;justify-content:center">
  <div class="card" style="width:340px">
    <div class="card-body">
      <h2 style="margin-bottom:24px;text-align:center">Admin Login</h2>
      <div class="form-group">
        <label>Admin Secret Key</label>
        <input type="password" id="admin-key-input" placeholder="Enter admin keyâ€¦" />
      </div>
      <button class="btn btn-primary btn-block" onclick="adminLogin()">Login</button>
    </div>
  </div>
</div>

<!-- â”€â”€ Admin panel (hidden until login) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<div id="admin-panel" class="hidden">

  <!-- Topbar -->
  <nav class="navbar" style="position:relative">
    <div class="container">
      <span class="brand">Abstract Realms â€” Admin</span>
      <nav>
        <button class="btn btn-outline btn-sm" onclick="adminLogout()">Logout</button>
      </nav>
    </div>
  </nav>

  <div class="admin-layout">

    <!-- â”€â”€ Sidebar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
    <aside class="admin-sidebar">
      <a href="#" class="active" onclick="showTab('orders', this)">ğŸ“¦ Orders</a>
      <a href="#" onclick="showTab('products', this)">â• Add Product</a>
    </aside>

    <!-- â”€â”€ Main content â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
    <main class="admin-content">

      <!-- â”€â”€ Orders tab â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
      <div id="tab-orders">
        <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:24px">
          <h2>All Orders</h2>
          <button class="btn btn-outline btn-sm" onclick="loadOrders()">ğŸ”„ Refresh</button>
        </div>

        <!-- Filters -->
        <div style="display:flex;gap:10px;flex-wrap:wrap;margin-bottom:20px">
          <select id="filter-status" onchange="applyFilter()" style="width:auto;padding:8px 12px">
            <option value="">All Statuses</option>
            <option>PAYMENT_PENDING</option>
            <option>PAYMENT_RECEIVED</option>
            <option>IN_PROGRESS</option>
            <option>COMPLETED</option>
          </select>
        </div>

        <div style="overflow-x:auto">
          <table class="orders-table">
            <thead>
              <tr>
                <th>Order ID</th>
                <th>Customer</th>
                <th>Phone</th>
                <th>Product</th>
                <th>Variant</th>
                <th>Qty</th>
                <th>Total</th>
                <th>Custom Design</th>
                <th>Payment Screenshot</th>
                <th>Status</th>
                <th>Date</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="orders-tbody">
              <tr><td colspan="12" style="text-align:center;padding:40px">
                <div class="spinner" style="margin:0 auto"></div>
              </td></tr>
            </tbody>
          </table>
        </div>
      </div>

      <!-- â”€â”€ Add product tab â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
      <div id="tab-products" class="hidden">
        <h2 style="margin-bottom:24px">Add New Product</h2>
        <div class="card" style="max-width:480px">
          <div class="card-body">
            <div class="form-group">
              <label>Product Name *</label>
              <input type="text" id="prod-name" placeholder="Custom Mug" />
            </div>
            <div class="form-group">
              <label>Category *</label>
              <select id="prod-category">
                <option value="mug">Mug</option>
                <option value="keychain">Keychain</option>
                <option value="magnet">Magnet</option>
                <option value="badge">Badge</option>
              </select>
            </div>
            <div class="form-group">
              <label>Base Price (â‚¹) *</label>
              <input type="number" id="prod-price" placeholder="250" min="0" />
            </div>
            <div class="form-group">
              <label>Stock *</label>
              <input type="number" id="prod-stock" placeholder="50" min="0" />
            </div>
            <button class="btn btn-primary btn-block" onclick="addProduct()">Create Product</button>
          </div>
        </div>
      </div>

    </main>
  </div>
</div>

<!-- â”€â”€ Update status modal â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<div id="status-modal" class="modal-backdrop">
  <div class="modal">
    <div class="modal-header">
      <h3>Update Order Status</h3>
      <button class="modal-close" onclick="closeStatusModal()">Ã—</button>
    </div>
    <p id="status-modal-order" class="text-muted" style="margin-bottom:16px"></p>
    <div class="form-group">
      <label>New Status</label>
      <select id="status-select">
        <option value="PAYMENT_PENDING">Payment Pending</option>
        <option value="PAYMENT_RECEIVED">Payment Received</option>
        <option value="IN_PROGRESS">In Progress</option>
        <option value="COMPLETED">Completed</option>
      </select>
    </div>
    <div style="display:flex;gap:12px;margin-top:16px">
      <button class="btn btn-primary" onclick="submitStatusUpdate()">Update</button>
      <button class="btn btn-outline" onclick="closeStatusModal()">Cancel</button>
    </div>
  </div>
</div>

<div id="toast-container"></div>
<script src="script.js"></script>
<script>
let adminKey = null;
let allOrders = [];
let pendingOrderId = null;

// â”€â”€ Auth â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function adminLogin() {
  const key = document.getElementById("admin-key-input").value.trim();
  if (!key) { toast("Enter the admin key", "error"); return; }
  adminKey = key;
  document.getElementById("login-screen").classList.add("hidden");
  document.getElementById("admin-panel").classList.remove("hidden");
  loadOrders();
}

function adminLogout() {
  adminKey = null;
  document.getElementById("admin-panel").classList.add("hidden");
  document.getElementById("login-screen").classList.remove("hidden");
  document.getElementById("admin-key-input").value = "";
}

document.getElementById("admin-key-input").addEventListener("keydown", (e) => {
  if (e.key === "Enter") adminLogin();
});

// â”€â”€ Tabs â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function showTab(name, link) {
  document.querySelectorAll(".admin-content > div").forEach(d => d.classList.add("hidden"));
  document.getElementById(`tab-${name}`).classList.remove("hidden");
  document.querySelectorAll(".admin-sidebar a").forEach(a => a.classList.remove("active"));
  link.classList.add("active");
}

// â”€â”€ Load orders â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadOrders() {
  const tbody = document.getElementById("orders-tbody");
  tbody.innerHTML = `<tr><td colspan="12" style="text-align:center;padding:40px">
    <div class="spinner" style="margin:0 auto"></div>
  </td></tr>`;

  try {
    allOrders = await apiFetch("/api/orders");
    applyFilter();
  } catch (e) {
    tbody.innerHTML = `<tr><td colspan="12" class="text-muted" style="padding:20px">
      Failed to load orders: ${e.message}
    </td></tr>`;
  }
}

function applyFilter() {
  const filterStatus = document.getElementById("filter-status").value;
  const filtered = filterStatus
    ? allOrders.filter(o => o.status === filterStatus)
    : allOrders;
  renderOrders(filtered);
}

const STATUS_COLORS = {
  PAYMENT_PENDING:  "#f59e0b",
  PAYMENT_RECEIVED: "#22c55e",
  IN_PROGRESS:      "#a5b4fc",
  COMPLETED:        "#86efac",
};

function renderOrders(orders) {
  const tbody = document.getElementById("orders-tbody");
  if (!orders.length) {
    tbody.innerHTML = `<tr><td colspan="12" class="text-muted" style="padding:20px;text-align:center">No orders found.</td></tr>`;
    return;
  }

  tbody.innerHTML = orders.map(o => `
    <tr>
      <td style="font-family:monospace;font-size:.8rem">${o.id}</td>
      <td>${o.customer_name}</td>
      <td>${o.phone}</td>
      <td>${o.product_name}</td>
      <td class="text-muted">${[o.material, o.shape].filter(Boolean).map(s=>s.replace(/_/g," ")).join(" Â· ") || "â€”"}</td>
      <td>${o.quantity}</td>
      <td style="font-weight:700">${formatINR(o.total_price)}</td>
      <td>
        ${o.image_url
          ? `<a href="${o.image_url}" target="_blank" download class="btn btn-outline btn-sm">â¬‡ Design</a>`
          : '<span class="text-muted">None</span>'}
      </td>
      <td>
        ${o.payment_screenshot_url
          ? `<a href="${o.payment_screenshot_url}" target="_blank" class="btn btn-success btn-sm">ğŸ“¸ View</a>`
          : '<span class="text-muted">None</span>'}
      </td>
      <td>
        <span style="color:${STATUS_COLORS[o.status] || '#fff'};font-weight:600;font-size:.82rem">
          ${o.status.replace(/_/g," ")}
        </span>
      </td>
      <td class="text-muted" style="font-size:.8rem">${new Date(o.created_at).toLocaleDateString("en-IN")}</td>
      <td>
        <div style="display:flex;gap:6px;flex-wrap:wrap">
          ${o.status === 'PAYMENT_PENDING'
            ? `<button class="btn btn-success btn-sm" onclick="quickStatus('${o.id}','PAYMENT_RECEIVED','${o.customer_name}')">âœ… Mark Paid</button>`
            : ''}
          ${o.status === 'PAYMENT_RECEIVED'
            ? `<button class="btn btn-primary btn-sm" onclick="quickStatus('${o.id}','IN_PROGRESS','${o.customer_name}')">ğŸ”¨ Start Work</button>`
            : ''}
          ${o.status === 'IN_PROGRESS'
            ? `<button class="btn btn-success btn-sm" onclick="quickStatus('${o.id}','COMPLETED','${o.customer_name}')">ğŸ‰ Complete</button>`
            : ''}
          <button class="btn btn-outline btn-sm" onclick="openStatusModal('${o.id}','${o.status}','${o.customer_name}')">âœï¸ Status</button>
          <a href="order.html?id=${o.id}" target="_blank" class="btn btn-outline btn-sm">View</a>
        </div>
      </td>
    </tr>
  `).join("");
}

// â”€â”€ Status update modal â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function openStatusModal(id, currentStatus, customerName) {
  pendingOrderId = id;
  document.getElementById("status-modal-order").textContent = `Order #${id} â€” ${customerName}`;
  document.getElementById("status-select").value = currentStatus;
  document.getElementById("status-modal").classList.add("open");
}

function closeStatusModal() {
  document.getElementById("status-modal").classList.remove("open");
  pendingOrderId = null;
}

async function submitStatusUpdate() {
  if (!pendingOrderId) return;
  const newStatus = document.getElementById("status-select").value;

  try {
    showLoading();
    await apiFetch("/api/update-order-status", {
      method: "POST",
      body: JSON.stringify({ id: pendingOrderId, status: newStatus, admin_key: adminKey }),
    });
    toast("Status updated successfully", "success");
    closeStatusModal();
    await loadOrders();
  } catch (e) {
    toast("Failed: " + e.message, "error");
  } finally {
    hideLoading();
  }
}

// â”€â”€ Quick status change (one-click buttons in table) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function quickStatus(id, status, customerName) {
  if (!confirm(`Mark order for "${customerName}" as "${status.replace(/_/g," ")}"?`)) return;
  try {
    showLoading();
    await apiFetch("/api/update-order-status", {
      method: "POST",
      body: JSON.stringify({ id, status, admin_key: adminKey }),
    });
    toast("Status updated!", "success");
    await loadOrders();
  } catch (e) {
    toast("Failed: " + e.message, "error");
  } finally {
    hideLoading();
  }
}

// â”€â”€ Add product â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function addProduct() {
  const name     = document.getElementById("prod-name").value.trim();
  const category = document.getElementById("prod-category").value;
  const price    = parseInt(document.getElementById("prod-price").value);
  const stock    = parseInt(document.getElementById("prod-stock").value);

  if (!name)          { toast("Product name required", "error"); return; }
  if (isNaN(price))   { toast("Valid price required", "error");  return; }

  try {
    showLoading();
    await apiFetch("/api/products", {
      method: "POST",
      body: JSON.stringify({ name, category, base_price: price, stock: stock || 0 }),
    });
    toast("Product created!", "success");
    document.getElementById("prod-name").value  = "";
    document.getElementById("prod-price").value = "";
    document.getElementById("prod-stock").value = "";
  } catch (e) {
    toast("Failed: " + e.message, "error");
  } finally {
    hideLoading();
  }
}
</script>
</body>
</html>
